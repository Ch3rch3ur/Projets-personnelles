# ğŸ› Troubleshooting - Projet Active Directory Linux

> **â±ï¸ Temps total de debug** : ~6 heures rÃ©parties sur 3 jours  
> **ğŸ’¡ ProblÃ¨mes majeurs** : 3 (DNS, SSSD cache, PAM)  
> **ğŸ“ Apprentissages clÃ©s** : MÃ©thodologie de diagnostic, distinction auth/autorisation, importance des logs

## ğŸ“Œ SythÃ¨se du document

**ProblÃ¨mes rencontrÃ©s** :
1. **DNS** : Mauvais nom de serveur (`srv-vm` au lieu de `srv-win`) â†’ DiagnostiquÃ© via `dig`
2. **SSSD** : Cache obsolÃ¨te bloquant les changements de config â†’ RÃ©solu avec `sss_cache -E`
3. **PAM** : Filtrage groupes AD mal configurÃ© â†’ Logs `/var/log/auth.log` ont rÃ©vÃ©lÃ© le problÃ¨me

**CompÃ©tences dÃ©montrÃ©es** : Diagnostic mÃ©thodique (DNS â†’ Kerberos â†’ SSSD â†’ PAM), lecture de logs systÃ¨me, rÃ©solution autonome d'incidents complexes

**Temps de rÃ©solution moyen** : 1-2h par incident

ğŸ‘‰ **DÃ©tails techniques complets ci-dessous**

---

Ce document dÃ©taille les **problÃ¨mes rÃ©els rencontrÃ©s** lors de l'intÃ©gration de systÃ¨mes Linux Ã  Active Directory, ainsi que les **mÃ©thodes de diagnostic appliquÃ©es** et les **solutions mises en Å“uvre**.

> **Note** : Tous les incidents dÃ©crits ici ont Ã©tÃ© rÃ©ellement rencontrÃ©s et rÃ©solus lors du projet. Les commandes et solutions sont celles qui ont effectivement fonctionnÃ©.

---

## ğŸ“‹ Vue d'ensemble des incidents

L'authentification centralisÃ©e repose sur une **chaÃ®ne de dÃ©pendances strictes** :
1. RÃ©solution DNS du domaine Active Directory
2. Authentification via Kerberos
3. RÃ©solution des identitÃ©s et groupes via LDAP/SSSD
4. Autorisation d'accÃ¨s via PAM

**Tout dysfonctionnement sur un flux en amont empÃªche les Ã©tapes suivantes.**

---

## 1. ğŸŒ DNS : RÃ©solution FQDN incomplÃ¨te et enregistrement incorrect

### SymptÃ´me initial

Impossible de rÃ©soudre le nom de domaine du serveur Active Directory depuis le client Linux.

```bash
$ ping srv-vm.homelab.local
ping: srv-vm.homelab.local: Nom ou service inconnu
```

### Diagnostic Ã©tape par Ã©tape

#### Ã‰tape 1 : VÃ©rifier la configuration /etc/hosts

```bash
cat /etc/hosts
```

**Contenu correct attendu** :
```
127.0.0.1       localhost
127.0.1.1       debian
192.168.2.3     srv-vm.homelab.local srv-vm
```

âœ… **Dans mon cas** : Le fichier Ã©tait correctement configurÃ©.

---

#### Ã‰tape 2 : VÃ©rifier /etc/nsswitch.conf

```bash
cat /etc/nsswitch.conf | grep hosts
```

**RÃ©sultat obtenu** :
```
hosts: files myhostname mdns4_minimal [NOTFOUND=return] dns
```

**ProblÃ¨me identifiÃ©** : La directive `[NOTFOUND=return]` empÃªche la rÃ©solution DNS si le fichier `/etc/hosts` ne contient pas l'entrÃ©e.

**Correction appliquÃ©e** :
```bash
sudo nano /etc/nsswitch.conf
```

Modifier la ligne pour :
```
hosts: files dns
```

**Tentative de redÃ©marrage** :
```bash
sudo systemctl restart systemd-resolved
```

**Erreur rencontrÃ©e** :
```
Failed to restart systemd-resolved.service: Unit systemd-resolved.service not found.
```

> **Note** : Sur Debian, `systemd-resolved` n'est pas toujours installÃ© par dÃ©faut. La configuration DNS passe alors par NetworkManager.

---

#### Ã‰tape 3 : VÃ©rifier /etc/resolv.conf

```bash
cat /etc/resolv.conf
```

**Contenu avant correction** :
```
# Generated by NetworkManager
nameserver 1.1.1.1
```

**ProblÃ¨me** : Le rÃ©solveur DNS pointait vers Cloudflare (1.1.1.1) au lieu du serveur Active Directory.

**Contenu attendu** :
```
nameserver 192.168.2.3
search homelab.local
```

**Solution temporaire** (non persistante) :
```bash
sudo nano /etc/resolv.conf
```

Remplacer par :
```
nameserver 192.168.2.3
search homelab.local
```

**ProblÃ¨me** : NetworkManager rÃ©Ã©crase ce fichier au redÃ©marrage.

---

#### Ã‰tape 4 : Rendre la configuration DNS persistante

```bash
sudo nano /etc/NetworkManager/conf.d/90-dns.conf
```

**Ajouter** :
```ini
[main]
dns=none
```

**RedÃ©marrer NetworkManager** :
```bash
sudo systemctl restart NetworkManager
```

**VÃ©rifier que /etc/resolv.conf n'est plus Ã©crasÃ©** :
```bash
cat /etc/resolv.conf
```

---

#### Ã‰tape 5 : Tester la rÃ©solution aprÃ¨s modifications

```bash
ping -c 3 srv-vm.homelab.local
```

**RÃ©sultat** : Toujours `Nom ou service inconnu`

---

#### Ã‰tape 6 : VÃ©rifier l'accessibilitÃ© du port DNS (53)

```bash
nc -vz 192.168.2.3 53
```

**RÃ©sultat** :
```
Connection to 192.168.2.3 53 port [tcp/domain] succeeded!
```

âœ… **Le serveur DNS est bien accessible.**

---

#### Ã‰tape 7 : Interroger directement le DNS Active Directory

```bash
dig @192.168.2.3 srv-vm.homelab.local
```

**RÃ©sultat obtenu** :
```
; <<>> DiG 9.20.15-1~deb13u1-Debian <<>> @192.168.2.3 srv-vm.homelab.local
; (1 server found)
;; global options: +cmd
;; Got answer:
;; WARNING: .local is reserved for Multicast DNS
;; You are currently testing what happens when an mDNS query is leaked to DNS
;; ->>HEADER<<- opcode: QUERY, status: NXDOMAIN, id: 48108
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4000
;; QUESTION SECTION:
;srv-vm.homelab.local.          IN      A

;; AUTHORITY SECTION:
homelab.local.          3600    IN      SOA     srv-win.homelab.local. hostmaster.homelab.local. 21 900 600 86400 3600

;; Query time: 0 msec
;; SERVER: 192.168.2.3#53(192.168.2.3) (UDP)
;; WHEN: Thu Nov 27 19:11:16 CET 2025
;; MSG SIZE  rcvd: 117
```

### ğŸ” Analyse du problÃ¨me

**Ã‰lÃ©ments clÃ©s du diagnostic** :

1. **`status: NXDOMAIN`** : Le serveur DNS rÃ©pond "ce nom n'existe pas"
2. **`ANSWER: 0`** : Aucun enregistrement DNS trouvÃ©
3. **`AUTHORITY SECTION`** montre **`srv-win.homelab.local`** : C'est le vrai nom du serveur !

**Cause identifiÃ©e** : **Erreur de nom**

J'avais configurÃ© `srv-vm.homelab.local` dans mes fichiers de configuration, mais le serveur Active Directory s'appelle en rÃ©alitÃ© **`srv-win.homelab.local`**.

### Solution

#### Corriger tous les fichiers de configuration avec le bon nom

1. **Mettre Ã  jour /etc/hosts** :

```bash
sudo nano /etc/hosts
```

```
127.0.0.1       localhost
127.0.1.1       debian
192.168.2.3     srv-win.homelab.local srv-win
```

2. **Mettre Ã  jour /etc/resolv.conf** (si nÃ©cessaire) :

```
nameserver 192.168.2.3
search homelab.local
```

3. **Tester la rÃ©solution** :

```bash
ping -c 3 srv-win.homelab.local
```

**RÃ©sultat** : âœ… Le ping fonctionne !

4. **VÃ©rifier avec getent** :

```bash
getent hosts srv-win.homelab.local
```

**RÃ©sultat attendu** :
```
192.168.2.3     srv-win.homelab.local srv-win
```

### VÃ©rification finale

```bash
# Test de rÃ©solution DNS
dig @192.168.2.3 srv-win.homelab.local

# Test des enregistrements SRV Kerberos
dig @192.168.2.3 SRV _kerberos._tcp.homelab.local

# Test des enregistrements SRV LDAP
dig @192.168.2.3 SRV _ldap._tcp.homelab.local
```

**Tous les tests doivent retourner des rÃ©ponses avec `status: NOERROR` et `ANSWER: 1` ou plus.**

---

## 2. ğŸ” SSSD / PAM : Authentification rÃ©ussie mais accÃ¨s SSH refusÃ©

### SymptÃ´me

AprÃ¨s avoir configurÃ© PAM pour crÃ©er automatiquement les home directories, la connexion SSH depuis Windows Server Ã©choue, alors qu'elle fonctionne en localhost.

```bash
# Depuis Windows Server
ssh Administrateur@homelab.local@192.168.2.2
Password:
Access denied
Connection closed by 192.168.2.2 port 22
```

**En local sur Debian** : La connexion fonctionne âœ…

### Diagnostic

#### Ã‰tape 1 : VÃ©rifier que SSH Ã©coute bien sur le port 22

```bash
sudo ss -tlnp | grep :22
```

**RÃ©sultat** :
```
LISTEN 0  128  0.0.0.0:22  0.0.0.0:*  users:(("sshd",pid=908,fd=3))
```

âœ… **SSH Ã©coute bien sur toutes les interfaces.**

---

#### Ã‰tape 2 : Consulter les logs SSH

```bash
sudo systemctl status ssh
```

**RÃ©sultat obtenu** :
```
â— ssh.service - OpenBSD Secure Shell server
     Loaded: loaded (/usr/lib/systemd/system/ssh.service; enabled; preset: enabled)
     Active: active (running) since Sun 2025-11-30 13:11:28 CET; 1h 7min ago
       Docs: man:sshd(8)
             man:sshd_config(5)
    Process: 873 ExecStartPre=/usr/sbin/sshd -t (code=exited, status=0/SUCCESS)
   Main PID: 908 (sshd)
      Tasks: 1 (limit: 1075)
     Memory: 5.7M (peak: 24.2M, swap: 1016K, swap peak: 1.2M)
        CPU: 366ms
     CGroup: /system.slice/ssh.service
             â””â”€908 "sshd: /usr/sbin/sshd -D [listener] 0 of 10-100 startups"

nov. 30 14:17:39 Debian sshd-session[4341]: pam_sss(sshd:auth): authentication success; logname= uid=0 euid=0 tty=ssh ruser= rhost=192.168.2.3 user=Administrateur@homelab.local
nov. 30 14:17:39 Debian sshd-session[4341]: pam_sss(sshd:account): Access denied for user Administrateur@homelab.local: 6 (Permission denied)
nov. 30 14:17:39 Debian sshd-session[4341]: fatal: Access denied for user Administrateur@homelab.local by PAM account configuration [preauth]
```

### ğŸ” Analyse du problÃ¨me

**Messages clÃ©s** :

1. **`pam_sss(sshd:auth): authentication success`** : âœ… L'authentification Kerberos fonctionne
2. **`pam_sss(sshd:account): Access denied for user Administrateur@homelab.local: 6 (Permission denied)`** : âŒ Refus lors de la phase "account"
3. **`fatal: Access denied by PAM account configuration`** : âŒ Configuration PAM incorrecte

**InterprÃ©tation** :

L'authentification rÃ©ussit (Kerberos OK), mais SSSD refuse l'accÃ¨s lors de la vÃ©rification des autorisations (phase "account" de PAM). Cela signifie que **le filtre d'accÃ¨s par groupe AD est mal configurÃ©**.

---

#### Ã‰tape 3 : VÃ©rifier la configuration SSSD

```bash
sudo cat /etc/sssd/sssd.conf
```

**Configuration trouvÃ©e** (problÃ©matique) :

```ini
[domain/homelab.local]
ad_domain = homelab.local
krb5_realm = HOMELAB.LOCAL
# ... autres paramÃ¨tres ...
ad_access_filter = (memberOf=CN=Utilisateurs du domaine,CN=Users,DC=homelab,DC=local)
```

**ProblÃ¨me identifiÃ©** : J'avais essayÃ© de filtrer l'accÃ¨s avec `ad_access_filter` en ciblant le groupe "Utilisateurs du domaine", mais :
- La syntaxe peut Ãªtre incorrecte
- Le nom exact du groupe peut diffÃ©rer
- Ce filtre empÃªche potentiellement tous les utilisateurs de se connecter

---

#### Ã‰tape 4 : VÃ©rifier le nom exact du groupe AD

Sur Windows Server, en PowerShell :

```powershell
Get-ADGroup -Identity "Utilisateurs du domaine" | Select-Object DistinguishedName
```

**RÃ©sultat** :
```
DistinguishedName
-----------------
CN=Utilisateurs du domaine,CN=Users,DC=homelab,DC=local
```

âœ… **Le groupe existe bien.**

Mais le filtre `ad_access_filter` n'est pas la bonne approche pour un premier test.

### Solution

#### Solution immÃ©diate : DÃ©sactiver le filtre d'accÃ¨s

```bash
sudo nano /etc/sssd/sssd.conf
```

**Commenter la ligne problÃ©matique** :
```ini
# ad_access_filter = (memberOf=CN=Utilisateurs du domaine,CN=Users,DC=homelab,DC=local)
```

**RedÃ©marrer SSSD** :
```bash
sudo systemctl restart sssd
```

**RÃ©sultat** : âŒ Le problÃ¨me persiste !

---

#### Purger le cache SSSD

**Cause** : SSSD utilise un **cache local**. MÃªme aprÃ¨s modification de la configuration, l'ancien cache peut encore Ãªtre utilisÃ©.

**Solution** : Purger le cache :

```bash
# ArrÃªter SSSD
sudo systemctl stop sssd

# Purger le cache
sudo sss_cache -E

# RedÃ©marrer SSSD
sudo systemctl start sssd
```

**VÃ©rification** :
```bash
# Tester Ã  nouveau la connexion SSH depuis Windows
ssh Administrateur@homelab.local@192.168.2.2
```

**RÃ©sultat** : âœ… **Connexion SSH acceptÃ©e !**

---

### Recommandation : Utiliser `simple_allow_groups` au lieu de `ad_access_filter`

Pour un contrÃ´le d'accÃ¨s plus simple et plus fiable, utiliser `access_provider = simple` :

```bash
sudo nano /etc/sssd/sssd.conf
```

**Configuration recommandÃ©e** :
```ini
[domain/homelab.local]
ad_domain = homelab.local
krb5_realm = HOMELAB.LOCAL
# ... autres paramÃ¨tres ...
access_provider = simple
simple_allow_groups = linux-users, linux-admins
```

**CrÃ©er les groupes AD correspondants sur Windows Server** :

```powershell
# CrÃ©er le groupe linux-users
New-ADGroup -Name "linux-users" -GroupScope Global -GroupCategory Security

# CrÃ©er le groupe linux-admins
New-ADGroup -Name "linux-admins" -GroupScope Global -GroupCategory Security

# Ajouter des utilisateurs
Add-ADGroupMember -Identity "linux-users" -Members Administrateur
Add-ADGroupMember -Identity "linux-admins" -Members Administrateur
```

**RedÃ©marrer SSSD et purger le cache** :
```bash
sudo systemctl restart sssd
sudo sss_cache -E
```

### VÃ©rification finale

```bash
# VÃ©rifier la rÃ©solution de l'utilisateur
id Administrateur@homelab.local

# VÃ©rifier les groupes
groups Administrateur@homelab.local

# Tester SSH
ssh Administrateur@homelab.local@192.168.2.2
```

---

## 3. ğŸ« Kerberos : Erreurs lors de kinit (mention rapide)

### SymptÃ´me

Impossible d'obtenir un ticket Kerberos malgrÃ© des identifiants valides.

```bash
$ kinit Administrateur@HOMELAB.LOCAL
kinit: Client 'Administrateur@HOMELAB.LOCAL' not found in Kerberos database
```

### Causes identifiÃ©es

- IncohÃ©rences DNS / realm (realm en minuscules au lieu de majuscules)
- Comptes AD dÃ©sactivÃ©s ou verrouillÃ©s
- Configuration `krb5.conf` incorrecte
- DÃ©synchronisation horaire (NTP)

### Solution appliquÃ©e

> **Note importante** : Les commandes Kerberos doivent Ãªtre exÃ©cutÃ©es **uniquement avec sudo** dans certains contextes pour Ã©viter les erreurs de permissions.

**Configuration correcte de `/etc/krb5.conf`** :

```ini
[libdefaults]
    default_realm = HOMELAB.LOCAL
    dns_lookup_realm = false
    dns_lookup_kdc = true

[realms]
    HOMELAB.LOCAL = {
        kdc = srv-win.homelab.local
        admin_server = srv-win.homelab.local
    }

[domain_realm]
    .homelab.local = HOMELAB.LOCAL
    homelab.local = HOMELAB.LOCAL
```

**Points critiques** :
- `default_realm` en **MAJUSCULES** : `HOMELAB.LOCAL`
- `kdc` et `admin_server` avec le **bon nom de serveur** : `srv-win.homelab.local`

**Test** :
```bash
kinit Administrateur@HOMELAB.LOCAL
klist
```

---

## 4. ğŸ  Home directories : RÃ©pertoires utilisateurs absents

### SymptÃ´me

AprÃ¨s une premiÃ¨re connexion SSH rÃ©ussie, le rÃ©pertoire personnel de l'utilisateur n'existe pas.

```bash
$ ssh utilisateur@homelab.local@192.168.2.2
Could not chdir to home directory /home/utilisateur@homelab.local: No such file or directory
```

### Solution

**Activer la crÃ©ation automatique des home directories via PAM** :

```bash
sudo nano /etc/pam.d/common-session
```

**Ajouter la ligne suivante** :
```
session required pam_mkhomedir.so skel=/etc/skel/ umask=0077
```

**RedÃ©marrer SSSD** :
```bash
sudo systemctl restart sssd
```

### VÃ©rification

```bash
# Se connecter avec un utilisateur
ssh utilisateur@homelab.local@192.168.2.2

# VÃ©rifier que le rÃ©pertoire a Ã©tÃ© crÃ©Ã©
ls -ld /home/utilisateur@homelab.local
```

**RÃ©sultat attendu** :
```
drwx------ 2 utilisateur@homelab.local domain users@homelab.local 4096 nov 30 14:30 /home/utilisateur@homelab.local
```

> **Note** : Lors de mes tests, j'ai remarquÃ© que l'ajout de cette ligne peut parfois causer des problÃ¨mes SSH si la configuration PAM est dÃ©jÃ  complexe. Dans mon cas, aprÃ¨s ajout de cette ligne, le SSH depuis Windows ne fonctionnait plus temporairement (voir section 2).

---

## ğŸ“Š SynthÃ¨se : Ordre de diagnostic en cas d'Ã©chec

Si l'authentification ne fonctionne pas, suivre cet ordre :

```
1. DNS
   â””â”€ Le nom du serveur AD est-il correct ?
       â”œâ”€ âŒ â†’ VÃ©rifier /etc/hosts, /etc/resolv.conf, et interroger le DNS avec dig
       â””â”€ âœ… â†’ Passer Ã  l'Ã©tape 2

2. KERBEROS
   â””â”€ kinit fonctionne ?
       â”œâ”€ âŒ â†’ VÃ©rifier krb5.conf (MAJUSCULES du realm), NTP, nom du serveur
       â””â”€ âœ… â†’ Passer Ã  l'Ã©tape 3

3. SSSD
   â””â”€ id utilisateur@domaine fonctionne ?
       â”œâ”€ âŒ â†’ VÃ©rifier config SSSD, redÃ©marrer le service
       â””â”€ âœ… â†’ Passer Ã  l'Ã©tape 4

4. PAM / FILTRAGE D'ACCÃˆS
   â””â”€ SSH fonctionne ?
       â”œâ”€ âŒ â†’ VÃ©rifier les logs, dÃ©sactiver ad_access_filter, PURGER LE CACHE SSSD
       â””â”€ âœ… â†’ Passer Ã  l'Ã©tape 5

5. HOME DIRECTORIES
   â””â”€ Le rÃ©pertoire /home/utilisateur@domaine existe ?
       â”œâ”€ âŒ â†’ Activer pam_mkhomedir dans /etc/pam.d/common-session
       â””â”€ âœ… â†’ Configuration complÃ¨te âœ…
```

---

## ğŸ”§ Commandes essentielles de diagnostic

### RÃ©solution DNS
```bash
# VÃ©rifier la config DNS
cat /etc/resolv.conf

# Tester la rÃ©solution
ping srv-win.homelab.local
getent hosts srv-win.homelab.local

# Interroger le DNS directement
dig @192.168.2.3 srv-win.homelab.local
dig @192.168.2.3 SRV _kerberos._tcp.homelab.local

# VÃ©rifier la connectivitÃ© DNS
nc -vz 192.168.2.3 53
```

### SSSD et authentification
```bash
# Ã‰tat du service
sudo systemctl status sssd

# Purger le cache SSSD (IMPORTANT !)
sudo sss_cache -E

# VÃ©rifier la rÃ©solution d'un utilisateur
id Administrateur@homelab.local
groups Administrateur@homelab.local

# Logs SSSD en temps rÃ©el
sudo tail -f /var/log/sssd/sssd_homelab.local.log
```

### SSH et PAM
```bash
# Logs SSH en temps rÃ©el
sudo tail -f /var/log/auth.log

# Ã‰tat du service SSH
sudo systemctl status ssh

# VÃ©rifier que SSH Ã©coute
sudo ss -tlnp | grep :22
```

### Kerberos
```bash
# Tester l'authentification
kinit Administrateur@HOMELAB.LOCAL

# Lister les tickets
klist

# DÃ©truire les tickets
kdestroy
```

---

## ğŸ’¡ LeÃ§ons apprises

### 1. Toujours vÃ©rifier le nom exact du serveur
L'erreur `srv-vm` vs `srv-win` m'a fait perdre du temps. **LeÃ§on** : Toujours faire un `dig` pour vÃ©rifier le nom exact dans le DNS AD.

### 2. Le cache SSSD peut Ãªtre traÃ®tre
MÃªme aprÃ¨s modification de la configuration, **TOUJOURS purger le cache SSSD** avec `sudo sss_cache -E`.

### 3. Les logs sont essentiels
Les messages dans `/var/log/auth.log` et `systemctl status ssh` ont Ã©tÃ© dÃ©cisifs pour identifier le problÃ¨me PAM.

### 4. NetworkManager Ã©crase /etc/resolv.conf
Pour rendre la configuration DNS persistante, il faut crÃ©er `/etc/NetworkManager/conf.d/90-dns.conf` avec `dns=none`.

### 5. Distinction auth vs account dans PAM
L'authentification peut rÃ©ussir (Kerberos OK) mais l'accÃ¨s Ãªtre refusÃ© (filtrage par groupe). Ce sont deux Ã©tapes sÃ©parÃ©es.

---

## ğŸ“š Commandes de vÃ©rification complÃ¨te

```bash
# 1. DNS
dig @192.168.2.3 srv-win.homelab.local
dig @192.168.2.3 SRV _kerberos._tcp.homelab.local

# 2. Kerberos
kinit Administrateur@HOMELAB.LOCAL
klist

# 3. SSSD
id Administrateur@homelab.local
groups Administrateur@homelab.local

# 4. SSH
ssh Administrateur@homelab.local@192.168.2.2

# 5. Logs
sudo tail -f /var/log/auth.log
sudo journalctl -u sssd -f
```

---

**Note finale** : Ce document reflÃ¨te mon expÃ©rience rÃ©elle du projet. Tous les problÃ¨mes dÃ©crits ont Ã©tÃ© rencontrÃ©s et rÃ©solus. Les commandes indiquÃ©es sont celles qui ont effectivement fonctionnÃ© dans mon environnement.
